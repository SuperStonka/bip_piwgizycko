<%- include('_header', { title, adminUser, activeTab: 'users' }) %>
    <div class="page-content">
    <div class="mt-3 mb-2" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
      <div>
        <h2 class="h4 mb-1" style="margin:0;">Użytkownicy</h2>
        <div class="text-muted" style="font-size:.95rem">Zarządzaj kontami użytkowników</div>
      </div>
      <button type="button" class="btn btn-primary" id="addUserBtn">Dodaj użytkownika</button>
    </div>

    <!-- Filters and search -->
    <div class="card" style="margin-bottom:1rem">
      <div class="card-body" style="padding:.75rem 1rem">
        <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:center">
          <input type="text" id="searchInput" class="login-input" placeholder="Szukaj po loginie, nazwie, emailu..." style="flex:1;min-width:200px;margin:0">
          <select id="roleFilter" class="login-input" style="width:auto;min-width:150px;margin:0">
            <option value="">Wszystkie role</option>
            <option value="admin">Administrator</option>
            <option value="editor">Edytor</option>
          </select>
          <select id="pageSize" class="login-input" style="width:auto;margin:0">
            <option value="10">10 na stronę</option>
            <option value="25">25 na stronę</option>
            <option value="50">50 na stronę</option>
            <option value="100">100 na stronę</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Users table -->
    <div class="card">
      <div class="card-body" style="padding:0;overflow-x:auto">
        <table class="table" id="usersTable" style="width:100%">
          <thead>
            <tr>
              <th data-sort="username" style="cursor:pointer">Login ↕</th>
              <th data-sort="name">Imię i nazwisko</th>
              <th data-sort="email" style="cursor:pointer">Email ↕</th>
              <th data-sort="role" style="cursor:pointer">Rola ↕</th>
              <th data-sort="created" style="cursor:pointer">Data utworzenia ↕</th>
              <th style="width:120px">Akcje</th>
            </tr>
          </thead>
          <tbody>
            <% if (users && users.length > 0) { %>
              <% users.forEach(function(user){ %>
                <tr data-id="<%= user.id %>">
                  <td><strong><%= user.username %></strong></td>
                  <td><%= (user.imie || '') + ' ' + (user.nazwisko || '') %></td>
                  <td><%= user.email %></td>
                  <td data-role="<%= user.role %>">
                    <span class="badge <%= user.role === 'admin' ? 'badge-success' : 'badge-draft' %>">
                      <%= user.role === 'admin' ? 'Administrator' : 'Edytor' %>
                    </span>
                  </td>
                  <td data-date="<%= new Date(user.created_at).getTime() %>">
                    <%= new Date(user.created_at).toLocaleDateString('pl-PL') %>
                  </td>
                  <td class="actions">
                    <button type="button" class="btn-icon btn-icon-primary js-edit-user" data-id="<%= user.id %>" title="Edytuj">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <% if (adminUser.role === 'admin') { %>
                    <button type="button" class="btn-icon yellow js-change-password" data-id="<%= user.id %>" data-username="<%= user.username %>" title="Zmień hasło">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </button>
                    <% } %>
                    <button type="button" class="btn-icon btn-icon-danger js-delete-user" data-id="<%= user.id %>" data-username="<%= user.username %>" title="Usuń">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="6" style="text-align:center;padding:2rem" class="text-muted">Brak użytkowników</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div style="display:flex;justify-content:center;margin-top:1rem;gap:.5rem" id="paginationControls"></div>
  </div>

  <!-- Add User Modal -->
  <div id="addUserModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">Dodaj użytkownika</div>
      <form id="addUserForm">
        <div class="modal-body">
          <div style="margin-bottom:1rem">
            <label class="login-label">Login <span class="req-star">*</span></label>
            <input type="text" class="login-input" name="username" required>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Imię</label>
            <input type="text" class="login-input" name="firstName">
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Nazwisko</label>
            <input type="text" class="login-input" name="lastName">
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Email <span class="req-star">*</span></label>
            <input type="email" class="login-input" name="email" required>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Hasło <span class="req-star">*</span></label>
            <div style="position:relative;display:flex;gap:.5rem;align-items:center">
              <input type="password" class="login-input" id="addPassword" name="password" required style="flex:1;margin:0">
              <button type="button" class="btn-icon" id="generatePasswordBtn" title="Generuj hasło">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
              </button>
              <button type="button" class="btn-icon" id="togglePasswordBtn" title="Pokaż/ukryj hasło">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
            </div>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Rola</label>
            <select class="login-input" name="role">
              <option value="editor">Edytor</option>
              <option value="admin">Administrator</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" id="addUserCancelBtn">Anuluj</button>
          <button type="submit" class="btn btn-primary">Dodaj użytkownika</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="editUserModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">Edytuj użytkownika</div>
      <form id="editUserForm">
        <input type="hidden" id="editUserId" name="id">
        <div class="modal-body">
          <div style="margin-bottom:1rem">
            <label class="login-label">Login <span class="req-star">*</span></label>
            <input type="text" class="login-input" id="editUsername" name="username" required>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Imię</label>
            <input type="text" class="login-input" id="editFirstName" name="firstName">
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Nazwisko</label>
            <input type="text" class="login-input" id="editLastName" name="lastName">
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Email <span class="req-star">*</span></label>
            <input type="email" class="login-input" id="editEmail" name="email" required>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Nowe hasło (pozostaw puste aby nie zmieniać)</label>
            <input type="password" class="login-input" id="editPassword" name="password">
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Rola</label>
            <select class="login-input" id="editRole" name="role">
              <option value="editor">Edytor</option>
              <option value="admin">Administrator</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" id="editUserCancelBtn">Anuluj</button>
          <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">Zmień hasło użytkownika</div>
      <form id="changePasswordForm">
        <input type="hidden" id="changePasswordUserId">
        <div class="modal-body">
          <p style="margin-bottom:1rem">Zmiana hasła dla: <strong id="changePasswordUsername"></strong></p>
          <div style="margin-bottom:1rem">
            <label class="login-label">Nowe hasło <span class="req-star">*</span></label>
            <div style="position:relative;display:flex;gap:.5rem;align-items:center">
              <input type="password" class="login-input" id="changePasswordInput" name="password" required style="flex:1;margin:0">
              <button type="button" class="btn-icon" id="generatePasswordChangeBtn" title="Generuj hasło">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
              </button>
              <button type="button" class="btn-icon" id="togglePasswordChangeBtn" title="Pokaż/ukryj hasło">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
              </button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" id="changePasswordCancelBtn">Anuluj</button>
          <button type="submit" class="btn btn-primary">Zmień hasło</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete User Modal -->
  <div id="deleteUserModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">Potwierdź usunięcie</div>
      <div class="modal-body">
        <p>Czy na pewno chcesz usunąć użytkownika <strong id="deleteUsername"></strong>?</p>
        <p class="text-muted">Ta operacja nie może zostać cofnięta.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" id="deleteUserCancelBtn">Anuluj</button>
        <button type="button" class="btn btn-danger" id="deleteUserConfirmBtn">Usuń</button>
      </div>
    </div>
    </div>

  <script src="/js/admin-users.js"></script>
<%- include('_footer') %>
