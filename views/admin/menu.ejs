<%- include('_header', { title, adminUser, activeTab: 'menu' }) %>
  <div class="page-content">
    <div class="mt-3 mb-2" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
      <div>
        <h2 class="h4 mb-1" style="margin:0;">Struktura menu</h2>
        <div class="text-muted" style="font-size:.95rem">Zarządzaj pozycjami menu i widocznością</div>
      </div>
      <button type="button" class="btn btn-primary" id="addMenuBtn">Dodaj pozycję</button>
    </div>

    <div class="card"><div class="card-body">
      <div style="display:grid;gap:.75rem">
        <% const byParent = (items||[]).reduce((acc, item)=>{ const k = item.parent_id || 0; (acc[k]=acc[k]||[]).push(item); return acc; }, {}); %>
        <% function renderGroup(parentId, level){ %>
          <% const group = (byParent[parentId||0]||[]).slice().sort(function(a,b){ return (a.sort_order||0) - (b.sort_order||0) || (a.id||0) - (b.id||0); }); %>
          <% group.forEach(function(mi){ %>
            <div class="menu-item-draggable" draggable="true" data-id="<%= mi.id %>" data-parent-id="<%= mi.parent_id || '' %>" style="border:1px solid var(--admin-border);border-radius:6px;padding:.5rem .75rem; background:#fff">
              <div style="display:flex;align-items:center;gap:.75rem;justify-content:space-between;flex-wrap:wrap">
                <div style="display:flex;align-items:center;gap:.75rem">
                  <span class="drag-handle" style="opacity:.6;cursor:move" title="Przeciągnij aby zmienić kolejność">⋮⋮</span>
                  <div>
                    <div style="font-weight:600"><%= mi.title %> <span class="badge <%= mi.hidden? 'badge-draft':'badge-success' %>"><%= mi.hidden? 'Ukryte':'Widoczne' %></span></div>
                    <div class="text-muted" style="font-size:.85rem">/<%= mi.slug %></div>
                    <div class="text-muted" style="font-size:.8rem"><%= mi.display_mode==='single' ? 'Pojedynczy artykuł' : (mi.display_mode==='list' ? 'Lista artykułów' : 'Tryb nieokreślony') %></div>
                  </div>
                </div>
                <div style="display:flex;gap:.4rem;align-items:center">
                  <label class="toggle-label <%= (mi.is_active == 1) ? 'label-active' : 'label-inactive' %>" style="margin:0 .25rem 0 0" data-for="active-<%= mi.id %>">Aktywne</label>
                  <input type="checkbox" id="active-<%= mi.id %>" class="js-toggle toggle-green-yellow" data-id="<%= mi.id %>" data-field="active" <%= (mi.is_active == 1) ? 'checked' : '' %>>
                  <label class="toggle-label <%= (mi.hidden == 1) ? 'label-inactive' : 'label-active' %>" style="margin:0 .25rem 0 .75rem" data-for="visible-<%= mi.id %>">Widoczne</label>
                  <input type="checkbox" id="visible-<%= mi.id %>" class="js-toggle toggle-green-yellow" data-id="<%= mi.id %>" data-field="visible" <%= (mi.hidden == 1) ? '' : 'checked' %>>
                  <span class="icon-separator"></span>
                  <button type="button" class="btn-icon btn-icon-primary js-edit-menu" data-id="<%= mi.id %>" title="Edytuj">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                  </button>
                  <span class="icon-separator"></span>
                  <button type="button" class="btn-icon btn-icon-danger js-delete-menu" data-id="<%= mi.id %>" data-title="<%= mi.title %>" title="Usuń">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                  </button>
                </div>
              </div>
              <% if ((byParent[mi.id]||[]).length) { %>
                <div style="margin-top:.5rem;margin-left:1.25rem;border-left:2px dotted #e5e7eb;padding-left:.75rem">
                  <% renderGroup(mi.id, (level||0)+1); %>
                </div>
              <% } %>
            </div>
          <% }); %>
        <% } %>
        <% renderGroup(null, 0); %>
      </div>
    </div></div>

  <!-- Modal dodawania pozycji menu -->
  <div id="addMenuModal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">Dodaj pozycję menu</div>
      <form id="addMenuForm">
        <div class="modal-body">
          <div style="margin-bottom:1rem">
            <label class="login-label">Tytuł <span class="req-star">*</span></label>
            <input type="text" class="login-input" id="menuTitle" name="title" required>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Slug</label>
            <input type="text" class="login-input" id="menuSlug" name="slug" placeholder="Automatycznie generowany z tytułu">
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Pozycja nadrzędna</label>
            <select class="login-input" id="menuParent" name="parent_id">
              <option value="">Brak (pozycja główna)</option>
              <% (items||[]).forEach(function(item) { %>
                <option value="<%= item.id %>"><%= item.title %></option>
              <% }); %>
            </select>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Tryb wyświetlania</label>
            <select class="login-input" id="menuDisplayMode" name="display_mode" required>
              <option value="single">Pojedynczy artykuł</option>
              <option value="list">Lista artykułów</option>
            </select>
          </div>
          <div style="display:flex;gap:2rem;margin-bottom:1rem">
            <label style="display:flex;align-items:center;gap:.5rem">
              <input type="checkbox" id="menuActive" name="is_active" checked>
              <span class="login-label" style="margin:0">Aktywne</span>
            </label>
            <label style="display:flex;align-items:center;gap:.5rem">
              <input type="checkbox" id="menuVisible" name="hidden" value="0" checked>
              <span class="login-label" style="margin:0">Widoczne</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" id="addMenuCancelBtn">Anuluj</button>
          <button type="submit" class="btn btn-primary">Dodaj pozycję</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal edycji pozycji menu -->
  <div id="editMenuModal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">Edytuj pozycję menu</div>
      <form id="editMenuForm">
        <input type="hidden" id="editMenuId" name="id">
        <div class="modal-body">
          <div style="margin-bottom:1rem">
            <label class="login-label">Tytuł <span class="req-star">*</span></label>
            <input type="text" class="login-input" id="editMenuTitle" name="title" required>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Slug</label>
            <input type="text" class="login-input" id="editMenuSlug" name="slug">
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Pozycja nadrzędna</label>
            <select class="login-input" id="editMenuParent" name="parent_id">
              <option value="">Brak (pozycja główna)</option>
              <% (items||[]).forEach(function(item) { %>
                <option value="<%= item.id %>"><%= item.title %></option>
              <% }); %>
            </select>
          </div>
          <div style="margin-bottom:1rem">
            <label class="login-label">Tryb wyświetlania</label>
            <select class="login-input" id="editMenuDisplayMode" name="display_mode" required>
              <option value="single">Pojedynczy artykuł</option>
              <option value="list">Lista artykułów</option>
            </select>
          </div>
          <div style="display:flex;gap:2rem;margin-bottom:1rem">
            <label style="display:flex;align-items:center;gap:.5rem">
              <input type="checkbox" id="editMenuActive" name="is_active">
              <span class="login-label" style="margin:0">Aktywne</span>
            </label>
            <label style="display:flex;align-items:center;gap:.5rem">
              <input type="checkbox" id="editMenuVisible" name="hidden" value="0">
              <span class="login-label" style="margin:0">Widoczne</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" id="editMenuCancelBtn">Anuluj</button>
          <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal potwierdzenia usunięcia -->
  <div id="deleteMenuModal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">Potwierdź usunięcie</div>
      <div class="modal-body">
        <p>Czy na pewno chcesz usunąć pozycję menu <strong id="deleteMenuTitle"></strong>?</p>
        <p class="text-muted">Ta operacja nie może zostać cofnięta.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" id="deleteMenuCancelBtn">Anuluj</button>
        <button type="button" class="btn btn-danger" id="deleteMenuConfirmBtn">Usuń</button>
      </div>
    </div>
  </div>
  </div>

  <script src="/js/admin-menu.js"></script>
<%- include('_footer') %>